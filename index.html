<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>NeuroFab ‚Äî Interactive UI (Full)</title>
<link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg-top:#0a3b27;
  --bg-mid:#0f5b3a;
  --bg-bottom:#021b12;
  --accent:#7fffd4;
  --accent-2:#5fe6b4;
  --accent-dark:#003b27;
  --muted:#dffbf3;
  --card:rgba(0,0,0,0.45);
  --glass-border:rgba(255,255,255,0.04);
  --control-h:56px;
  --corner-gap:26px;
  --hover-translate:-8px;
  --hover-shadow:0 24px 50px rgba(0,0,0,0.55);
  --pop-glow:0 0 30px rgba(127,255,212,0.2);
  --tab-gap:10px;
  --tab-radius:12px;
  --tab-selected-bg:var(--accent);
  --tab-selected-color:var(--accent-dark);
  --modal-bg:rgba(0,0,0,0.85);
}

/* Global */
*{box-sizing:border-box;font-family:'Comfortaa',cursive!important;}
html,body{height:100%;margin:0;background:linear-gradient(160deg,var(--bg-top) 0%, var(--bg-mid) 45%, var(--bg-bottom) 100%);background-attachment:fixed;color:var(--muted);-webkit-font-smoothing:antialiased;}
a{color:inherit;text-decoration:none}

/* Page layout */
.page{padding-top:140px;padding-left:var(--corner-gap);padding-right:var(--corner-gap)}
.wrap{max-width:1180px;margin:0 auto}

/* Header */
.header{display:flex;justify-content:center;align-items:center;gap:20px;margin-bottom:18px}
.logo-box{width:100px;height:100px;border-radius:16px;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04));border:1px solid var(--glass-border);box-shadow:0 18px 40px rgba(0,0,0,0.45)}
.logo-svg{width:120px;height:120px;color:var(--accent)}
.title-wrap{display:flex;flex-direction:column;align-items:center}
.title{font-size:54px;margin:0;color:var(--accent);font-weight:700;white-space:nowrap}
.subtitle{margin-top:6px;color:var(--accent);font-weight:300;white-space:nowrap}

/* Fixed history and top controls */
.history-btn{position:fixed;left:var(--corner-gap);top:var(--corner-gap);height:var(--control-h);display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:12px;background:var(--card);border:1px solid var(--glass-border);color:var(--accent);cursor:pointer;box-shadow:0 12px 30px rgba(0,0,0,0.45);transition:transform .12s,box-shadow .12s;z-index:120}
.history-btn:hover{transform:translateY(var(--hover-translate));box-shadow:var(--hover-shadow)}
.history-btn svg{width:20px;height:20px;display:block}

/* top-controls (theme + speed) */
.top-controls{position:fixed;right:var(--corner-gap);top:var(--corner-gap);display:flex;gap:18px;z-index:120}
.control{height:var(--control-h);padding:12px;border-radius:12px;background:var(--card);border:1px solid var(--glass-border);display:flex;flex-direction:column;justify-content:center;position:relative;cursor:pointer;box-shadow:0 12px 30px rgba(0,0,0,0.45);transition:transform .12s,box-shadow .12s;color:inherit;min-width:160px}
.control:hover{transform:translateY(var(--hover-translate));box-shadow:var(--hover-shadow)}
.control-label{position:absolute;top:8px;left:50%;transform:translateX(-50%);font-size:12px;font-weight:700;white-space:nowrap;color:white}
.select-row{display:flex;align-items:center;justify-content:space-between;line-height:1}
.swatch{width:18px;height:18px;border-radius:4px;border:1px solid rgba(255,255,255,0.06);flex-shrink:0;flex-grow:0;background:transparent;display:inline-block}

/* Theme control: larger so closed box doesn't wrap */
#themeControl{min-width:240px}

/* dropdown */
.dropdown{display:none;position:absolute;top:calc(100% + 10px);left:50%;transform:translateX(-50%);background:var(--card);border:1px solid var(--glass-border);border-radius:12px;overflow:hidden;min-width:200px;width:auto;text-align:left;z-index:250;box-shadow:0 16px 40px rgba(0,0,0,0.5)}
.dropdown .item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  cursor: pointer;
  color: var(--muted);
}
.dropdown .item:hover{background:rgba(255,255,255,0.02);transform:translateY(-3px)}
.dropdown .item .text {
  flex: 1;               /* Take remaining space */
  text-align: center;    /* Center horizontally in that space */
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* Info & card */
.info{max-width:1000px;margin:0 auto;margin-bottom:18px;padding:12px 18px;border-radius:14px;border:1px solid rgba(255,255,255,0.04);background:linear-gradient(180deg, rgba(0,0,0,0.06), rgba(0,0,0,0.04));box-shadow:0 10px 30px rgba(0,0,0,0.45);text-align:center;color:var(--accent);transition:transform .12s,box-shadow .12s}
.info:hover{transform:translateY(var(--hover-translate));box-shadow:var(--hover-shadow)}
.card{max-width:980px;margin:0 auto;padding:22px;border-radius:16px;background:linear-gradient(180deg, rgba(0,0,0,0.5), rgba(0,0,0,0.43));border:1px solid rgba(127,255,212,0.03);box-shadow:0 30px 80px rgba(0,0,0,0.6);transition:transform .12s,box-shadow .12s;color:var(--accent)}
.card:hover{transform:translateY(var(--hover-translate));box-shadow:var(--hover-shadow)}
.card .heading{text-align:center;font-size:22px;margin:0 0 12px;font-weight:700;color:var(--accent)}

/* textarea (prompt) - full width inside card */
textarea{width:100%;min-height:160px;border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.04);background:rgba(0,0,0,0.25);color:var(--muted);resize:vertical;transition:transform .12s,box-shadow .12s}
textarea:hover,textarea:focus{transform:translateY(var(--hover-translate));box-shadow:var(--hover-shadow);outline:none}

/* controls row */
.controls-row{display:flex;justify-content:space-between;align-items:center;color:var(--accent);gap:12px}
.controls-row input[type=checkbox]{cursor:pointer;transition:transform .12s,box-shadow .12s}
.controls-row input[type=checkbox]:hover{transform:translateY(var(--hover-translate));box-shadow:var(--hover-shadow)}

/* generate button - MATCH PROMPT width: full width inside the card */
.generate-wrap{margin-top:22px;display:flex;justify-content:center}
.btn-generate{width:100%;padding:14px 22px;border-radius:12px;background:linear-gradient(180deg,var(--accent),var(--accent-2));border:none;font-weight:800;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;color:var(--accent-dark);box-shadow:inset 0 6px 18px rgba(255,255,255,0.03),0 18px 40px rgba(0,0,0,0.55);transition:transform .12s,box-shadow .12s}
.btn-generate:hover{transform:translateY(var(--hover-translate));box-shadow:var(--hover-shadow)}
.btn-generate:disabled{opacity:0.55;cursor:not-allowed}

/* Download All button (same width as generate, centered) */
#downloadAllWrap{margin-top:14px;display:none;justify-content:center}
#downloadAllBtn{width:100%;padding:12px 18px;border-radius:12px;background:linear-gradient(180deg,var(--accent-2),var(--accent));border:none;font-weight:800;font-size:16px;cursor:pointer;color:var(--accent-dark);box-shadow:0 12px 30px rgba(0,0,0,0.45)}

/* Tabs */
.tabs-wrap{margin-top:18px;display:none;max-width:980px;margin-left:auto;margin-right:auto}
.tabs{display:flex;gap:var(--tab-gap);align-items:stretch;width:100%}
.tab-btn{flex:1;padding:12px 14px;border-radius:var(--tab-radius);background:var(--card);color:var(--accent);cursor:pointer;border:1px solid var(--glass-border);font-weight:700;transition:all .18s;display:flex;align-items:center;justify-content:center;gap:8px}
.tab-btn:hover{transform:translateY(-4px)}
.tab-btn.active{background:var(--tab-selected-bg);color:var(--tab-selected-color);box-shadow:0 8px 20px rgba(0,0,0,0.35)}
.tab-content{margin-top:12px;padding:16px;border-radius:12px;background:rgba(0,0,0,0.28);border:1px solid rgba(255,255,255,0.03);min-height:160px;color:var(--muted);transition:all .18s;white-space:pre-wrap}

/* tab controls (copy, download) under tabs */
.tab-controls{display:flex;gap:12px;margin-top:10px;justify-content:flex-end}
.action-btn{padding:10px 12px;border-radius:10px;background:var(--card);border:1px solid var(--glass-border);cursor:pointer;font-weight:700;color:var(--accent);transition:all .12s}
.action-btn:hover{transform:translateY(-4px);box-shadow:var(--pop-glow)}

/* history modal (fixed, translucent) */
#historyModal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:92%;max-width:1200px;height:86%;border-radius:16px;display:none;flex-direction:column;z-index:400;box-shadow:0 40px 120px rgba(0,0,0,0.7);overflow:hidden;background:var(--modal-bg);border:1px solid var(--glass-border)}
#historyHeader{display:flex;align-items:center;justify-content:space-between;padding:18px;border-bottom:1px solid rgba(255,255,255,0.06);font-weight:800;color:var(--accent);background:linear-gradient(180deg, rgba(0,0,0,0.02), rgba(0,0,0,0))}
#closeHistoryBtn{background:transparent;border:none;font-size:20px;color:var(--accent);cursor:pointer;padding:8px;border-radius:8px}
#historyInner{display:flex;flex-direction:column;padding:16px;height:100%}
#historySearch{padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:rgba(0,0,0,0.12);color:var(--muted);margin-bottom:12px}
#historyList{flex:1;overflow:auto;display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px;padding-right:6px}
.history-card{background:linear-gradient(180deg, rgba(0,0,0,0.22), rgba(0,0,0,0.12));padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;gap:8px}
.history-title{font-weight:800;color:var(--accent)}
.history-desc{color:var(--muted)}
.history-prompt{color:rgba(255,255,255,0.75);font-style:italic}
.history-actions{display:flex;gap:8px;justify-content:flex-end}

/* small screens */
@media(max-width:780px){
  .top-controls{right:12px;flex-direction:column}
  .control{min-width:160px}
  #historyList{grid-template-columns:1fr}
  .logo-svg{width:96px;height:96px}
  .title{font-size:36px}
  .tab-btn{padding:10px}
}
#themeControl .select-row > div {
  display: flex;
  align-items: center;
  flex: 1;            /* Fill remaining space */
}

#themeName {
  flex: 1;             /* Take all horizontal space after swatch */
  text-align: center;  /* Center the text */
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.control .dropdown {
  width: 100%;       /* Make dropdown match the parent control width */
  left: 0;           /* Align left edge with parent */
  transform: none;   /* Remove the old translateX */
}
.control {
  padding-top: 28px; /* leave enough space for the label */
  padding-bottom: 12px;
}

</style>
</head>
<body>
<!-- History button -->
<button id="historyBtn" class="history-btn" title="History" aria-haspopup="dialog" aria-label="Open history">
  <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
    <circle cx="32" cy="32" r="28" stroke="currentColor" stroke-width="2" fill="none"/>
    <line x1="32" y1="18" x2="32" y2="32" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
    <line x1="32" y1="32" x2="42" y2="32" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
  </svg>
  <span style="font-weight:700">History</span>
</button>

<!-- Top controls: theme + speed -->
<div class="top-controls" role="toolbar" aria-label="Controls">
  <div class="control" id="themeControl" tabindex="0" aria-haspopup="menu" aria-expanded="false" title="Change theme">
    <div class="control-label">Theme</div>
    <div class="select-row">
      <div style="display:flex;align-items:center;gap:10px;min-width:0;max-width:100%">
        <div id="themeSwatch" class="swatch" aria-hidden="true"></div>
        <div id="themeName" style="font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">Glacial Mint</div>
      </div>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><polyline points="6 9 12 15 18 9" stroke="currentColor" stroke-width="1.6"/></svg>
    </div>
    <div class="dropdown" id="themeDropdown" role="menu" aria-label="Theme options"></div>
  </div>

  <div class="control" id="speedControl" tabindex="0" aria-haspopup="menu" aria-expanded="false" title="Change generation speed">
    <div class="control-label">Speed</div>
    <div class="select-row">
      <div id="speedName" style="font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">‚öôÔ∏è Moderate</div>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><polyline points="6 9 12 15 18 9" stroke="currentColor" stroke-width="1.6"/></svg>
    </div>
    <div class="dropdown" id="speedDropdown" role="menu" aria-label="Speed options"></div>
  </div>
</div>

<!-- Main page -->
<div class="page">
  <div class="wrap">
    <header class="header" role="banner">
      <div class="logo-box" aria-hidden="true">
        <svg class="logo-svg" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <g stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none">
            <path d="M20 30c-3-6 0-12 6-14 6-2 12 2 14 6 6-1 12 2 14 8 2 6-2 12-8 14H22c-6 0-8-6-2-14z"/>
            <line x1="40" y1="20" x2="40" y2="14"/>
            <circle cx="40" cy="12" r="2" fill="currentColor"/>
            <line x1="48" y1="34" x2="48" y2="40"/>
            <circle cx="48" cy="40" r="2" fill="currentColor"/>
            <line x1="28" y1="38" x2="28" y2="44"/>
            <circle cx="28" cy="44" r="2" fill="currentColor"/>
            <path d="M22 28h10"/>
            <path d="M36 34h10"/>
          </g>
        </svg>
      </div>
      <div class="title-wrap">
        <div class="title">NeuroFab</div>
        <div class="subtitle">AI-Powered Engineering Design Generator</div>
      </div>
    </header>

    <div class="info">üí° How to use: Describe your complete project idea ‚Üí Click Generate ‚Üí Browse results ‚Üí Download</div>

    <div class="card" role="main" aria-labelledby="heading">
      <div class="heading" id="heading">Describe Your Complete Project Idea</div>
      <textarea id="ideaInput" placeholder="Example: Build a battery-powered plant watering system using ESP32..."></textarea>

      <div class="controls-row" style="margin-top:12px">
        <div id="modeDescription">Balanced ‚Ä¢ Good detail ‚Ä¢ Reliable JSON</div>
        <label style="display:flex;align-items:center;gap:8px"><input id="skipCAD" type="checkbox"> Skip CAD</label>
      </div>

      <div class="generate-wrap" style="margin-top:18px">
        <button id="generateBtn" class="btn-generate" disabled aria-live="polite" aria-label="Generate project">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="margin-right:8px" aria-hidden="true"><polyline points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" stroke="var(--accent-dark)" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <span id="genLabel">Generate Complete Project</span>
        </button>
      </div>

      <!-- download all under generate -->
      <div id="downloadAllWrap" style="display:none;justify-content:center;margin-top:10px">
        <button id="downloadAllBtn" class="btn-generate" aria-hidden="true">Download All</button>
      </div>

      <!-- Tabs (appear after generation) -->
      <div class="tabs-wrap" id="tabsWrap" aria-hidden="true" style="display:none">
        <div class="tabs" id="tabs" role="tablist" aria-label="Result tabs"></div>
        <div class="tab-controls" id="tabControls" style="margin-top:12px"></div>
        <div class="tab-content" id="tabContent" role="region" aria-live="polite" style="margin-top:10px"></div>
      </div>

      <!-- results quick area -->
      <div id="results" class="results" aria-live="polite"></div>
    </div>
  </div>
</div>

<!-- HISTORY MODAL -->
<div id="historyModal" role="dialog" aria-modal="true" aria-hidden="true">
  <div id="historyHeader">Project History
    <button id="closeHistoryBtn" aria-label="Close history">‚úï</button>
  </div>
  <div id="historyInner">
    <input id="historySearch" placeholder="Search projects..." />
    <div id="historyList" aria-live="polite"></div>
  </div>
</div>

<script>
/* ====== DATA ====== */
const THEMES = [
  { id:'mint', name:'Glacial Mint', accent:'#7fffd4', accentDark:'#5fe6b4', textDark:'#003b27', bgTop:'#0a3b27', bgMid:'#0f5b3a', bgBottom:'#021b12' },
  { id:'ocean', name:'Ocean Blue', accent:'#4A90E2', accentDark:'#357ABD', textDark:'#042f5f', bgTop:'#06263f', bgMid:'#0d3f62', bgBottom:'#02203a' },
  { id:'purple', name:'Royal Purple', accent:'#BB8FCE', accentDark:'#7D3C98', textDark:'#3a1550', bgTop:'#1a092b', bgMid:'#32165a', bgBottom:'#0e0820' },
  { id:'orange', name:'Sunset Orange', accent:'#FF8C42', accentDark:'#E67E22', textDark:'#5c2c08', bgTop:'#3a1208', bgMid:'#6a2c0c', bgBottom:'#2b0b05' }
];
const SPEEDS = [
  { id:'max_speed', label:'‚ö° Max Speed', desc:'~20‚Äì35s ‚Ä¢ Short outputs', model:'fast' },
  { id:'moderate', label:'‚öôÔ∏è Moderate', desc:'~45‚Äì60s ‚Ä¢ Balanced', model:'balanced' },
  { id:'max_detail', label:'üî¨ Max Detail', desc:'~90‚Äì120s ‚Ä¢ Detailed', model:'detailed' }
];
const TAB_LIST = [
  { id:'plan', label:'Project Plan' },
  { id:'bom', label:'Electronics BOM' },
  { id:'code', label:'Code' },
  { id:'cad', label:'CAD Model' },
  { id:'assembly', label:'Assembly Guide' },
  { id:'tips', label:'Helpful Tips' }
];

/* ====== STATE ====== */
let state = {
  theme: 'mint',
  speed: 'moderate',
  loading: false,
  history: [],
  generated: null,
  activeTab: 'plan'
};

/* ====== ELEMENTS ====== */
const themeControl = document.getElementById('themeControl');
const themeDropdown = document.getElementById('themeDropdown');
const themeSwatch = document.getElementById('themeSwatch');
const themeName = document.getElementById('themeName');
const speedControl = document.getElementById('speedControl');
const speedDropdown = document.getElementById('speedDropdown');
const speedName = document.getElementById('speedName');
const ideaInput = document.getElementById('ideaInput');
const generateBtn = document.getElementById('generateBtn');
const genLabel = document.getElementById('genLabel');
const skipCADBox = document.getElementById('skipCAD');
const resultsDiv = document.getElementById('results');
const tabsWrap = document.getElementById('tabsWrap');
const tabsEl = document.getElementById('tabs');
const tabContent = document.getElementById('tabContent');
const tabControls = document.getElementById('tabControls');
const downloadAllWrap = document.getElementById('downloadAllWrap');
const downloadAllBtn = document.getElementById('downloadAllBtn');
const historyBtn = document.getElementById('historyBtn');
const historyModal = document.getElementById('historyModal');
const closeHistoryBtn = document.getElementById('closeHistoryBtn');
const historyList = document.getElementById('historyList');
const historySearch = document.getElementById('historySearch');

/* ====== THEME + DROPDOWNS ====== */
function applyTheme(id){
  const t = THEMES.find(x=>x.id===id) || THEMES[0];
  state.theme = id;
  document.documentElement.style.setProperty('--accent', t.accent);
  document.documentElement.style.setProperty('--accent-2', t.accentDark);
  document.documentElement.style.setProperty('--accent-dark', t.textDark || '#003');
  document.documentElement.style.setProperty('--bg-top', t.bgTop);
  document.documentElement.style.setProperty('--bg-mid', t.bgMid);
  document.documentElement.style.setProperty('--bg-bottom', t.bgBottom);
  document.documentElement.style.setProperty('--tab-selected-bg', t.accent);
  document.documentElement.style.setProperty('--tab-selected-color', t.textDark || '#003');
  // update name & swatch
  themeName.textContent = t.name;
  themeSwatch.style.background = t.accent;
  // Modify visible elements color to match theme
  document.querySelectorAll('.logo-svg, .card, .info, .controls-row div, .title, .subtitle').forEach(el => {
    el.style.color = t.accent;
  });
  // history header/title color
  document.querySelectorAll('#historyHeader, .history-title').forEach(el => el.style.color = t.accent);

  // history button icon/text light
  document.querySelectorAll('.history-btn').forEach(el => el.style.color = t.accent);

  // buttons contrast: make sure generate/download have dark text for legibility
  document.querySelectorAll('.btn-generate, #downloadAllBtn').forEach(b => {
    b.style.color = t.textDark || '#003';
  });

  // update tab styling live
  updateTabStyles();
}

/* build theme dropdown */
function buildThemeDropdown(){
  themeDropdown.innerHTML = '';
  THEMES.forEach(t => {
    const it = document.createElement('div');
    it.className = 'item';
    it.innerHTML = `<div class="swatch" style="background:${t.accent}"></div><div class="text">${t.name}</div>`;
    it.tabIndex = 0;
    it.addEventListener('click', e => { e.stopPropagation(); applyTheme(t.id); themeDropdown.style.display='none'; renderTabs(); });
    it.addEventListener('keydown', e => { if(e.key==='Enter') it.click(); });
    themeDropdown.appendChild(it);
  });
}

/* build speed dropdown */
function buildSpeedDropdown(){
  speedDropdown.innerHTML = '';
  SPEEDS.forEach(s => {
    const it = document.createElement('div');
    it.className = 'item';
    it.innerHTML = `<div class="text">${s.label}</div>`;
    it.tabIndex = 0;
    it.addEventListener('click', e => { e.stopPropagation(); setSpeed(s.id); speedDropdown.style.display='none'; });
    it.addEventListener('keydown', e => { if(e.key==='Enter') it.click(); });
    speedDropdown.appendChild(it);
  });
}

function setSpeed(id){
  const s = SPEEDS.find(x=>x.id===id) || SPEEDS[1];
  state.speed = id;
  speedName.textContent = s.label;
  document.getElementById('modeDescription').textContent = s.desc || '';
}

/* dropdown toggles */
themeControl.addEventListener('click', e => { e.stopPropagation(); speedDropdown.style.display='none'; themeDropdown.style.display = themeDropdown.style.display==='block' ? 'none' : 'block'; });
speedControl.addEventListener('click', e => { e.stopPropagation(); themeDropdown.style.display='none'; speedDropdown.style.display = speedDropdown.style.display==='block' ? 'none' : 'block'; });
window.addEventListener('click', ()=>{ themeDropdown.style.display='none'; speedDropdown.style.display='none'; });

/* keyboard accessibility */
themeControl.addEventListener('keydown', e => { if(e.key==='Enter' || e.key===' ') { e.preventDefault(); themeControl.click(); } });
speedControl.addEventListener('keydown', e => { if(e.key==='Enter' || e.key===' ') { e.preventDefault(); speedControl.click(); } });

/* ====== HISTORY ====== */
function openHistory(){ historyModal.style.display='flex'; historyModal.setAttribute('aria-hidden','false'); renderHistory(); }
function closeHistory(){ historyModal.style.display='none'; historyModal.setAttribute('aria-hidden','true'); }
historyBtn.addEventListener('click', openHistory);
closeHistoryBtn.addEventListener('click', closeHistory);
historySearch.addEventListener('input', renderHistory);

function loadHistoryFromStorage(){
  try{
    const raw = localStorage.getItem('neurofab_history_v1');
    if(raw){
      state.history = JSON.parse(raw);
    } else state.history = [];
  }catch(e){ state.history = []; console.error('Load history failed', e); }
}
function saveHistoryToStorage(){
  try{
    localStorage.setItem('neurofab_history_v1', JSON.stringify(state.history.slice(0,200)));
  }catch(e){ console.error('Save history failed', e); }
}

function saveToHistory(record){
  // ensure unique by id (newest first)
  state.history = [record].concat(state.history.filter(r => r.id !== record.id));
  if(state.history.length > 200) state.history.length = 200;
  saveHistoryToStorage();
  renderHistory();
}

function renderHistory(){
  historyList.innerHTML = '';
  const q = (historySearch.value || '').toLowerCase();
  const list = state.history.filter(h => {
    if(!q) return true;
    return (h.title||'').toLowerCase().includes(q) || (h.desc||'').toLowerCase().includes(q) || (h.prompt||'').toLowerCase().includes(q);
  });
  if(list.length === 0){
    historyList.innerHTML = `<div style="color:rgba(255,255,255,0.6);padding:20px;text-align:center">No projects yet ‚Äî generate one to see it here.</div>`;
    return;
  }
  list.forEach(h => {
    const card = document.createElement('div');
    card.className = 'history-card';
    card.innerHTML = `
      <div class="history-title">${escapeHtml(h.title)}</div>
      <div class="history-desc">${escapeHtml(h.desc || '')}</div>
      <div class="history-prompt">${escapeHtml(h.prompt || '')}</div>
      <div class="history-actions">
        <button class="action-btn" data-action="open" data-id="${h.id}" title="Open project">Open</button>
        <button class="action-btn" data-action="copy" data-id="${h.id}" title="Copy generated text">Copy</button>
        <button class="action-btn" data-action="download" data-id="${h.id}" title="Download generated text">Download</button>
        <button class="action-btn" data-action="delete" data-id="${h.id}" title="Delete" style="background:#ff4444;color:#111">Delete</button>
      </div>
    `;
    // wire actions
    card.querySelectorAll('[data-action]').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        e.stopPropagation();
        const act = btn.dataset.action;
        const id = btn.dataset.id;
        handleHistoryAction(act, id);
      });
    });
    card.addEventListener('click', ()=>{ openProjectInUI(h); closeHistory(); });
    historyList.appendChild(card);
  });
}

function handleHistoryAction(action, id){
  const idx = state.history.findIndex(x => String(x.id) === String(id));
  if(idx === -1) return;
  const rec = state.history[idx];
  if(action === 'open'){ openProjectInUI(rec); closeHistory(); }
  else if(action === 'copy'){ navigator.clipboard.writeText(rec.generatedText || rec.plan || rec.bom || rec.code || rec.assembly || rec.tips || ''); flashMessage('Copied to clipboard'); }
  else if(action === 'download'){ downloadStringAsFile(rec.generatedText || rec.plan || rec.bom || rec.code || rec.assembly || rec.tips || '', `${sanitizeFilename(rec.title||'project')}.txt`); }
  else if(action === 'delete'){ if(confirm('Delete this project?')){ state.history.splice(idx,1); saveHistoryToStorage(); renderHistory(); } }
}

/* open project into UI: populate textarea and results */
function openProjectInUI(rec){
  ideaInput.value = rec.prompt || '';
  generateBtn.disabled = false;
  if(rec.generated){
    loadGeneratedIntoUI(rec.generated);
  } else {
    resultsDiv.innerHTML = `<div style="padding:12px;border-radius:10px;background:rgba(0,0,0,0.25);color:var(--muted)"><strong>${escapeHtml(rec.title)}</strong><div style="white-space:pre-wrap;margin-top:8px">${escapeHtml(rec.generatedText || rec.plan || '')}</div></div>`;
  }
}


/* Generate click */
ideaInput.addEventListener('input', ()=> {
  generateBtn.disabled = ideaInput.value.trim().length < 3;
});
generateBtn.addEventListener('click', async () => {
  if (generateBtn.disabled) return;

  try {
    generateBtn.disabled = true;
    const prevLabel = genLabel.textContent;
    genLabel.textContent = 'Generating...';

    const prompt = ideaInput.value.trim();

    const res = await fetch("/api/generate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        prompt,
        speed: state.speed,
        skipCAD: skipCADBox.checked
      })
    });

    if (!res.ok) {
      throw new Error("API request failed");
    }

    const generated = await res.json();

    state.generated = generated;

    saveToHistory({
      id: generated.id || Date.now(),
      title: generated.projectName || 'Generated Project',
      desc: (generated.plan || '').split('\n')[1] || '',
      prompt,
      generated,
      generatedText:
        (generated.plan || '') + "\n\n" +
        (generated.bom || '') + "\n\n" +
        (generated.code || '')
    });

    loadGeneratedIntoUI(generated);
    genLabel.textContent = prevLabel;

  } catch (e) {
    alert('Generation failed: ' + e.message);
    genLabel.textContent = 'Generate Complete Project';
  } finally {
    generateBtn.disabled = ideaInput.value.trim().length < 3;
  }
});


/* Load generated content into UI */
function loadGeneratedIntoUI(g){
  downloadAllWrap.style.display = 'flex';
  tabsWrap.style.display = 'block';
  downloadAllBtn.onclick = downloadAllGenerated;
  state.generated = g;
  renderTabs();
  state.activeTab = TAB_LIST.find(t => t.id === 'plan').id;
  renderActiveTab(false);
  // quick results display
  resultsDiv.innerHTML = `<div style="margin-top:18px;padding:12px;border-radius:10px;background:rgba(0,0,0,0.25);border:1px solid rgba(255,255,255,0.03)"><strong style="color:var(--accent)">${escapeHtml(g.projectName)}</strong><div style="color:rgba(200,255,240,0.85);white-space:pre-wrap;margin-top:8px">${escapeHtml(g.plan)}</div></div>`;
}

/* ====== TABS ====== */
function renderTabs(){
  tabsEl.innerHTML = '';
  tabControls.innerHTML = '';
  const showCad = !skipCADBox.checked;
  TAB_LIST.forEach(tab => {
    if(tab.id === 'cad' && !showCad) return;
    const btn = document.createElement('button');
    btn.className = 'tab-btn';
    btn.dataset.tab = tab.id;
    btn.setAttribute('role','tab');
    btn.innerHTML = `<span>${tab.label}</span>`;
    btn.addEventListener('click', ()=> {
      state.activeTab = tab.id;
      renderActiveTab(true);
    });
    tabsEl.appendChild(btn);
  });
  updateTabStyles();
}

function renderActiveTab(animated = true){
  Array.from(tabsEl.children).forEach(b=>{
    if(b.dataset.tab === state.activeTab) b.classList.add('active'); else b.classList.remove('active');
  });
  const g = state.generated || {};
  const contentMap = {
    plan: g.plan || 'No plan available',
    bom: g.bom || 'No BOM available',
    code: g.code || 'No code available',
    cad: g.cad || 'No CAD available',
    assembly: g.assembly || 'No assembly guide available',
    tips: g.tips || 'No tips available'
  };
  if(animated){
    tabContent.style.opacity = 0;
    setTimeout(()=>{ tabContent.innerText = contentMap[state.activeTab]; tabContent.style.opacity = 1; }, 120);
  } else {
    tabContent.innerText = contentMap[state.activeTab];
  }
  // tab controls
  tabControls.innerHTML = '';
  const copyBtn = document.createElement('button'); copyBtn.className='action-btn'; copyBtn.textContent='Copy'; copyBtn.onclick = ()=>{ navigator.clipboard.writeText(contentMap[state.activeTab]||''); flashMessage('Copied'); };
  const downloadBtn = document.createElement('button'); downloadBtn.className='action-btn'; downloadBtn.textContent='Download'; downloadBtn.onclick = ()=>{ downloadStringAsFile(contentMap[state.activeTab]||'', `${sanitizeFilename((state.generated?.projectName||'project') + '_' + state.activeTab)}.txt`); };
  tabControls.appendChild(copyBtn); tabControls.appendChild(downloadBtn);
  updateTabStyles();
}

/* update tab styles based on theme and which is active */
function updateTabStyles(){
  const t = THEMES.find(x=>x.id===state.theme) || THEMES[0];
  document.querySelectorAll('.tab-btn').forEach(btn=>{
    if(btn.classList.contains('active')){
      btn.style.background = t.accent;
      btn.style.color = t.textDark || '#003';
      btn.style.borderColor = 'transparent';
    } else {
      btn.style.background = 'var(--card)';
      btn.style.color = t.accent;
      btn.style.borderColor = 'var(--glass-border)';
    }
  });
  document.querySelectorAll('.action-btn').forEach(b=>{
    b.style.color = t.accent;
    b.style.background = 'var(--card)';
  });
  document.querySelectorAll('.btn-generate, #downloadAllBtn').forEach(b=>{
    b.style.color = t.textDark || '#003';
  });
  // ensure history header color
  document.getElementById('historyHeader').style.color = t.accent;
}

/* Download all generated parts as files */
function downloadAllGenerated(){
  if(!state.generated) return;
  const g = state.generated;
  downloadStringAsFile(g.plan||'', `${sanitizeFilename(g.projectName)}_plan.txt`);
  downloadStringAsFile(g.bom||'', `${sanitizeFilename(g.projectName)}_bom.txt`);
  downloadStringAsFile(g.code||'', `${sanitizeFilename(g.projectName)}_code.txt`);
  if(g.cad) downloadStringAsFile(g.cad||'', `${sanitizeFilename(g.projectName)}_cad.scad`);
  downloadStringAsFile(g.assembly||'', `${sanitizeFilename(g.projectName)}_assembly.txt`);
  downloadStringAsFile(g.tips||'', `${sanitizeFilename(g.projectName)}_tips.txt`);
}

/* ====== UTILITIES ====== */
function downloadStringAsFile(str, filename){
  const blob = new Blob([str], {type:'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(a.href); }, 200);
}
function sanitizeFilename(s){
  return (s||'file').replace(/[^a-z0-9_\-\.]/gi,'_').slice(0,160);
}
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
function flashMessage(msg){
  const el = document.createElement('div');
  el.textContent = msg;
  el.style.position='fixed'; el.style.right='20px'; el.style.top='80px'; el.style.background='rgba(0,0,0,0.6)';
  el.style.color='var(--muted)'; el.style.padding='10px 14px'; el.style.borderRadius='8px'; el.style.zIndex=900;
  document.body.appendChild(el);
  setTimeout(()=>el.style.opacity=0,1400);
  setTimeout(()=>document.body.removeChild(el),2000);
}

/* ====== helper: auto-hide CAD tab when Skip checked ====== */
skipCADBox.addEventListener('change', ()=> {
  if(state.generated){ renderTabs(); renderActiveTab(false); }
});

/* ====== keyboard accessibility & ESC handling ====== */
window.addEventListener('keydown', (e)=> {
  if(e.key === 'Escape'){
    if(historyModal.style.display === 'flex') closeHistory();
    themeDropdown.style.display='none';
    speedDropdown.style.display='none';
  }
});

/* ====== initial setup ====== */
(function init(){
  // wire dropdown lists
  buildThemeDropdown();
  buildSpeedDropdown();
  // load history
  loadHistoryFromStorage();
  // initial theme
  applyTheme(state.theme);
  setSpeed(state.speed);
  // configure buttons widths: prompt and generate are both full width inside card by CSS
  // ensure downloadAll is hidden
  downloadAllWrap.style.display = 'none';
  tabsWrap.style.display = 'none';
  // set downloadAll style consistent
  downloadAllBtn.className = 'btn-generate';
  downloadAllBtn.style.margin = '0 auto';
  // ensure history modal is fixed and not affecting page layout
  historyModal.style.display = 'none';
  // ensure generate button disabled initially
  generateBtn.disabled = true;
})();
</script>
</body>
</html>

